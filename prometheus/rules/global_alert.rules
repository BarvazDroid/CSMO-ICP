# Global alerts - for services which we are scraping or probing

# Alert for any service that is down for >1 minute.
ALERT KubernetesServiceDown
  IF probe_success == 0
  FOR 1m
  LABELS {
    severity = "critical",
    service = "{{ $labels.service_name }}",
    instance = "{{ $labels.instance }}",
    alert_situation = "{{ $labels.job }}_{{ $labels.service_name }}_probe_failure_service_down"
  }
  ANNOTATIONS {
    summary = "service {{ $labels.service_name }} probe success check failed.",
    description = "service {{ $labels.service_name }} job {{ $labels.job }} is down - probe attempt is failing",
    runbook = "https://alchemy-prod.hursley.ibm.com/docs/runbooks/armada/armada-global-probe_failure_service_down.html",
}

# Alert for any service-endpoint scrape that is failing for >1 minute.
ALERT KubernetesEndpointScrapeFailure
  IF up{job="kubernetes-service-endpoints"} == 0
  FOR 1m
  LABELS {
    severity = "critical",
    service = "{{ $labels.service_name }}",
    instance = "{{ $labels.instance }}",
    hostname = "{{ $labels.hostname }}",
    alert_situation = "{{ $labels.hostname }}_{{ $labels.job }}_{{ $labels.service_name }}_scrape_failure"
  }
  ANNOTATIONS {
    summary = "A service-endpoint hosted on {{ $labels.hostname}} is failing to scrape",
    description = "The {{ $labels.service_name }} service-endpoint on host {{ $labels.hostname }} has been failing to scrape for more than 1 minute.  Prometheus has been unable to scrape for data",
    runbook = "https://alchemy-prod.hursley.ibm.com/docs/runbooks/armada/armada-global-scrape-failure.html",
  }
